<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Chatbot Dashboard</title>
  <style>
    body {
      font-family: "Inter", sans-serif;
      margin: 0;
      background: #f5f6fa;
      color: #333;
    }

    header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 10px 24px;
      background: #ffffff;
      border-bottom: 2px solid #e5e7eb;
    }

    header img {
      height: 40px;
    }

    .chatbot-btn {
      padding: 8px 16px;
      border-radius: 8px;
      border: none;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: 0.2s;
      color: #fff;
      background: #800000; /* ƒë·ªè r∆∞·ª£u vang */
      text-decoration: none;
      display: inline-block;
    }

    .chatbot-btn:hover {
      background: #5c0000;
    }

    main {
      padding: 20px;
      max-width: 900px;
      margin: auto;
    }

    h2 {
      margin-bottom: 16px;
      color: #111827;
    }

    .conversation-card {
      background: white;
      border-radius: 12px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.08);
      padding: 16px;
      margin-bottom: 16px;
      transition: transform 0.2s, background 0.2s;
      cursor: pointer;
    }

    .conversation-card:hover {
      transform: translateY(-2px);
      background: #fdf2f2;
    }

    .conversation-info {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
    }

    .conversation-title {
      font-weight: 600;
      font-size: 16px;
      color: #800000;
    }

    .conversation-time {
      font-size: 13px;
      color: #6b7280;
    }

    .actions {
      margin-bottom: 10px;
    }

    .btn {
      border: none;
      border-radius: 8px;
      padding: 6px 10px;
      font-size: 14px;
      cursor: pointer;
      margin-right: 6px;
      transition: 0.2s;
      color: white;
    }

    .btn-analyze { background: #2563eb; }
    .btn-analyze:hover { background: #1d4ed8; }

    .btn-update { background: #f59e0b; }
    .btn-update:hover { background: #d97706; }

    .btn-delete { background: #ef4444; }
    .btn-delete:hover { background: #dc2626; }

    .analysis {
      background: #f9fafb;
      border-radius: 8px;
      padding: 10px;
      font-size: 14px;
      color: #374151;
      display: none;
    }
  </style>
</head>
<body>
  <header>
    <img src="https://quattran.vn/wp-content/uploads/2022/08/quat-mrvu-logo.jpg.webp" alt="Logo"/>
    <a href="chat.html" class="chatbot-btn">Mr.V≈© Chatbot</a>
  </header>

  <main>
    <h2>üìÇ Danh s√°ch cu·ªôc tr√≤ chuy·ªán</h2>
    <div id="list"></div>
  </main>

  <script>
    async function loadConversations() {
      const res = await fetch("/api/conversations");
      const data = await res.json();
      const list = document.getElementById("list");
      list.innerHTML = "";

      data.forEach(conv => {
        const div = document.createElement("div");
        div.className = "conversation-card";
        div.innerHTML = `
          <div class="conversation-info">
            <div class="conversation-title">üí¨ Cu·ªôc tr√≤ chuy·ªán</div>
            <div class="conversation-time">‚è∞ ${new Date(conv.created_at).toLocaleString()}</div>
          </div>
          <div class="actions">
            <button class="btn btn-analyze">üìë Analyze</button>
            <button class="btn btn-update">‚úèÔ∏è Update</button>
            <button class="btn btn-delete">üóë Delete</button>
          </div>
          <div class="analysis"></div>
        `;

        div.onclick = (e) => {
          if (!e.target.classList.contains("btn")) {
            window.location.href = `conversation.html?id=${conv.conservation_id}`;
          }
        };

        div.querySelector(".btn-analyze").onclick = async (e) => {
          e.stopPropagation();
          const analysisBox = div.querySelector(".analysis");
          analysisBox.style.display = "block";
          analysisBox.innerHTML = "‚è≥ ƒêang ph√¢n t√≠ch...";
          try {
            const res = await fetch(`/api/analyze/${conv.conservation_id}`, { method: "POST" });
            const result = await res.json();
            analysisBox.innerHTML = `
              <b>üë§ Name:</b> ${result.customername || "-"}<br>
              <b>üìß Email:</b> ${result.customeremail || "-"}<br>
              <b>üì± Phone:</b> ${result.customerphone || "-"}<br>
              <b>üè≠ Industry:</b> ${result.customerindustry || "-"}<br>
              <b>‚ùó Problem:</b> ${result.customerproblem || "-"}<br>
              <b>üìÖ Availability:</b> ${result.customeravailability || "-"}<br>
              <b>üìå Consultation:</b> ${result.customerconsultation ? "‚úÖ Yes" : "‚ùå No"}<br>
              <b>üìù Notes:</b> ${result.specialnotes || "-"}<br>
              <b>‚≠ê Lead Quality:</b> <span style="color:${
                result.leadquality === "good" ? "green" : result.leadquality === "ok" ? "orange" : "red"
              }">${result.leadquality || "-"}</span>
            `;
          } catch (err) {
            analysisBox.innerHTML = "‚ùå L·ªói ph√¢n t√≠ch!";
          }
        };

        div.querySelector(".btn-update").onclick = (e) => {
          e.stopPropagation();
          window.location.href = `update.html?id=${conv.conservation_id}`;
        };

        div.querySelector(".btn-delete").onclick = async (e) => {
          e.stopPropagation();
          if (confirm("B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a cu·ªôc tr√≤ chuy·ªán n√†y?")) {
            await fetch(`/api/conversations/${conv.conservation_id}`, { method: "DELETE" });
            div.remove();
          }
        };

        list.appendChild(div);
      });
    }

    loadConversations();
  </script>
</body>
</html>
